@page "/orderform"
@page "/orderform/{Ticker?}"

@using yQuant.App.Web.Services
@using yQuant.Core.Models
@using yQuant.Core.Ports.Output.Infrastructure
@inject OrderPublisher OrderPublisher
@inject AssetService AssetService
@inject AccountCacheService AccountCacheService
@inject StockService StockService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar

<PageTitle>Manual Order</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Manual Order</MudText>

<MudForm Model="@OrderModel" @ref="@Form" ValidationDelay="0">
    <MudGrid>
        <MudItem xs="12" sm="6">
            <MudSelect @bind-Value="OrderModel.AccountAlias" Label="Account" Required="true"
                RequiredError="Account is required!" Variant="Variant.Outlined">
                @foreach (var account in AvailableAccounts)
                {
                    <MudSelectItem Value="@account.Alias">@account.Alias (@account.Broker)</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudTextField T="string" Value="@OrderModel.Ticker" ValueChanged="OnTickerChanged" Label="Ticker" Required="true"
                RequiredError="Ticker is required!" Variant="Variant.Outlined" DebounceInterval="500" />
            @if (!string.IsNullOrEmpty(_stockName))
            {
                <MudText Typo="Typo.caption" Color="Color.Info">@_stockName</MudText>
            }
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudSelect @bind-Value="OrderModel.Action" Label="Action" Required="true"
                RequiredError="Action is required!" Variant="Variant.Outlined">
                <MudSelectItem Value="OrderAction.Buy">Buy</MudSelectItem>
                <MudSelectItem Value="OrderAction.Sell">Sell</MudSelectItem>
            </MudSelect>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudNumericField @bind-Value="OrderModel.Qty" Label="Quantity" Required="true"
                RequiredError="Quantity must be greater than 0" Min="1" Variant="Variant.Outlined" />
        </MudItem>
        <MudItem xs="12">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" OnClick="SubmitOrder"
                Disabled="@(!Form?.IsValid ?? true)">Place Order</MudButton>
        </MudItem>
    </MudGrid>
</MudForm>

@code {
    [Parameter]
    public string? Ticker { get; set; } // From URL parameter
    [Parameter]
    public OrderAction? Action { get; set; } // From URL parameter
    [Parameter]
    public string? AccountAlias { get; set; } // From URL parameter

    private MudForm? Form;
    private Order OrderModel = new()
        {
            AccountAlias = "",
            Ticker = "",
            Action = OrderAction.Buy,
            Type = OrderType.Market,
            Qty = 1 // Default quantity
        };
    private IEnumerable<Account> AvailableAccounts = new List<Account>();

    protected override async Task OnInitializedAsync()
    {
        // Read query string parameters
        var uri = new Uri(NavigationManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        
        var accountParam = query["account"];
        var tickerParam = query["ticker"];
        var actionParam = query["action"];

        await LoadAccounts();

        // Apply query string parameters if present
        if (!string.IsNullOrEmpty(accountParam))
        {
            OrderModel.AccountAlias = accountParam;
        }
        
        if (!string.IsNullOrEmpty(tickerParam))
        {
            OrderModel.Ticker = tickerParam.ToUpper();
            await UpdateStockName(OrderModel.Ticker);
        }
        
        if (!string.IsNullOrEmpty(actionParam) && Enum.TryParse<OrderAction>(actionParam, true, out var parsedAction))
        {
            OrderModel.Action = parsedAction;
        }

        // Set default quantity to 1 if coming from a link
        if (!string.IsNullOrEmpty(tickerParam) || !string.IsNullOrEmpty(accountParam))
        {
            OrderModel.Qty = 1;
        }

        // Trigger form validation and UI update
        StateHasChanged();
        await Task.Delay(100); // Small delay to ensure form is rendered
        if (Form != null)
        {
            await Form.Validate();
        }
    }



    private async Task LoadAccounts()
    {
        AvailableAccounts = await AccountCacheService.GetAccountsAsync();

        if (Ticker != null) OrderModel.Ticker = Ticker;
        if (Action != null) OrderModel.Action = Action.Value;
        if (AccountAlias != null) OrderModel.AccountAlias = AccountAlias;

        // Set default AccountAlias if accounts exist and none selected
        if (AvailableAccounts.Any() && string.IsNullOrEmpty(OrderModel.AccountAlias))
        {
            OrderModel.AccountAlias = AvailableAccounts.First().Alias;
        }

        // Default to Buy if not specified
        if (OrderModel.Action == 0) OrderModel.Action = OrderAction.Buy;

        if (!string.IsNullOrEmpty(OrderModel.Ticker))
        {
            await UpdateStockName(OrderModel.Ticker);
        }
    }

    private string? _stockName;

    private async Task OnTickerChanged(string ticker)
    {
        OrderModel.Ticker = ticker?.ToUpper() ?? "";
        await UpdateStockName(OrderModel.Ticker);
    }

    private async Task UpdateStockName(string ticker)
    {
        if (string.IsNullOrWhiteSpace(ticker))
        {
            _stockName = null;
            return;
        }
        _stockName = await StockService.GetStockNameAsync(ticker);
    }

    private async Task SubmitOrder()
    {
        await Form!.Validate();
        if (Form.IsValid)
        {
            try
            {
                // Ensure price and type are set for market order
                OrderModel.Type = OrderType.Market;
                OrderModel.Price = 0; // Market orders don't need a specific price on creation

                await OrderPublisher.PublishOrderAsync(OrderModel);
                Snackbar.Add("Order placed successfully!", Severity.Success);
                NavigationManager.NavigateTo("/dashboard"); // Go back to dashboard after placing order
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error placing order: {ex.Message}", Severity.Error);
                _ = Task.Delay(5000).ContinueWith(_ => InvokeAsync(StateHasChanged));
            }
        }
    }


}
