@page "/login"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using System.Security.Claims
@using yQuant.App.Web.Services
@inject NavigationManager Navigation
@inject SimpleAuthService AuthService

<PageTitle>Login - yQuant</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudPaper Elevation="3" Class="pa-8">
        <MudStack Spacing="4">
            <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Class="mr-2" />
                Login
            </MudText>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Filled">
                    @_errorMessage
                    </MudAlert>
            }

            <MudForm @ref="_form" @bind-IsValid="@_isValid">
                <MudStack Spacing="3">
                    <MudTextField @bind-Value="_username" Label="Username" Required="true" Variant="Variant.Outlined"
                        Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Person"
                        OnKeyDown="HandleKeyDown" autocapitalize="none" autocorrect="off" spellcheck="false" />

                    <MudTextField @bind-Value="_password" Label="Password" InputType="InputType.Password"
                        Required="true" Variant="Variant.Outlined" Adornment="Adornment.Start"
                        AdornmentIcon="@Icons.Material.Filled.Key" OnKeyDown="HandleKeyDown" />

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Large"
                        OnClick="HandleLogin" Disabled="@(!_isValid || _isLoading)">
                        @if (_isLoading)
                        {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>Logging in...</span>
                        }
                        else
                        {
                                <MudIcon Icon="@Icons.Material.Filled.Login" Class="mr-2" />
                                <span>Login</span>
                        }
                    </MudButton>
                </MudStack>
            </MudForm>

        </MudStack>
    </MudPaper>

    <form id="loginForm" action="/account/login" method="post" style="display:none">
        <input type="hidden" name="username" value="@_username" />
        <input type="hidden" name="password" value="@_password" />
        <input type="hidden" name="returnUrl" value="@ReturnUrl" />
    </form>
</MudContainer>

@code {
    private MudForm _form = null!;
    private bool _isValid;
    private bool _isLoading;
    private string _username = string.Empty;
    private string _password = string.Empty;
    private string _errorMessage = string.Empty;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromQuery(Name = "returnUrl")]
    private string? ReturnUrl { get; set; }

    @inject IJSRuntime JSRuntime

    private async Task HandleLogin()
    {
        _isLoading = true;
        _errorMessage = string.Empty;

        try
        {
            // Pre-validate credentials to provide fast feedback
            if (!await AuthService.ValidateCredentialsAsync(_username, _password))
            {
                _errorMessage = "Invalid username or password";
                _isLoading = false;
                return;
            }

            // If valid, submit the hidden form to create the cookie
            await JSRuntime.InvokeVoidAsync("submitForm", "loginForm");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Login failed: {ex.Message}";
            _isLoading = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && _isValid && !_isLoading)
        {
            await HandleLogin();
        }
    }
}
