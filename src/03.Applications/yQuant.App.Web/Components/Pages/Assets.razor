@page "/assets"
@page "/assets/{AccountAlias}"

@using yQuant.Core.Models

@using yQuant.App.Web.Services
@using yQuant.Core.Ports.Output.Infrastructure
@inject AssetService AssetService
@inject AccountCacheService AccountCacheService
@inject StockService StockService
@inject NavigationManager NavigationManager
@inject OrderPublisher OrderPublisher
@inject ISnackbar Snackbar

<div class="d-flex align-center justify-space-between mb-4">
    <MudText Typo="Typo.h4">Asset Summary</MudText>
    <MudButtonGroup Color="Color.Primary" Variant="Variant.Outlined">
        @foreach (var acc in _availableAccounts)
        {
            var isSelected = AccountAlias == acc.Alias;
            <MudButton OnClick="@(() => OnAccountChanged(acc.Alias))"
                Variant="@(isSelected ? Variant.Filled : Variant.Outlined)"
                Color="@(isSelected ? Color.Primary : Color.Default)" Size="@(isSelected ? Size.Medium : Size.Small)"
                Style="@(isSelected ? "font-weight: bold; box-shadow: 0 3px 5px rgba(0,0,0,0.2);" : "")">
                @acc.Alias
            </MudButton>
        }
    </MudButtonGroup>
</div>

@if (account == null)
{
    @if (!string.IsNullOrEmpty(AccountAlias))
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudText>Please select an account.</MudText>
    }
}
else
{
    <MudGrid>
    <MudItem xs="12" sm="6" md="4">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Total Equity (KRW)</MudText>
                <MudText Typo="Typo.h4">@account.GetTotalEquity(CurrencyType.KRW).ToString("N0") KRW</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Total Equity (USD)</MudText>
                <MudText Typo="Typo.h4">@account.GetTotalEquity(CurrencyType.USD).ToString("N2") USD</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Account Info</MudText>
                <MudText><b>Alias:</b> @account.Alias</MudText>
                <MudText><b>Number:</b> @account.Number</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12">
        <MudText Typo="Typo.h5" GutterBottom="true" Class="mt-4">Deposits</MudText>
        <MudTable Items="@account.Deposits" Hover="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Currency</MudTh>
                <MudTh>Amount</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Currency">@context.Key</MudTd>
                <MudTd DataLabel="Amount">@context.Value.ToString("N2")</MudTd>
            </RowTemplate>
        </MudTable>
    </MudItem>

    <MudItem xs="12">
        <MudText Typo="Typo.h5" GutterBottom="true" Class="mt-4">Positions</MudText>
        <MudTable Items="@account.Positions.Values.SelectMany(list => list)" Hover="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Ticker</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Currency</MudTh>
                <MudTh>Qty</MudTh>
                <MudTh>Avg Price</MudTh>
                <MudTh>Cur Price</MudTh>
                <MudTh>PnL</MudTh>
                <MudTh>Return %</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Ticker">@context.Ticker</MudTd>
                <MudTd DataLabel="Name">@GetStockName(context.Ticker)</MudTd>
                <MudTd DataLabel="Currency">@context.Currency</MudTd>
                <MudTd DataLabel="Qty">@context.Qty</MudTd>
                <MudTd DataLabel="Avg Price">@context.AvgPrice.ToString("N2")</MudTd>
                <MudTd DataLabel="Cur Price">@context.CurrentPrice.ToString("N2")</MudTd>
                <MudTd DataLabel="PnL" Style="@GetColorStyle(context.UnrealizedPnL)">
                    @context.UnrealizedPnL.ToString("N2")</MudTd>
                <MudTd DataLabel="Return %" Style="@GetColorStyle(context.UnrealizedPnL)">
                    @GetReturnRate(context).ToString("F2")%</MudTd>
                <MudTd DataLabel="Actions">
                    <MudButton OnClick="@(() => OpenQuickOrderDrawer(context, OrderAction.Buy))" Color="Color.Success"
                        Size="Size.Small" Variant="Variant.Outlined" Style="padding: 2px 6px;">Buy</MudButton>
                    <MudButton OnClick="@(() => OpenQuickOrderDrawer(context, OrderAction.Sell))" Color="Color.Error"
                        Size="Size.Small" Variant="Variant.Outlined" Style="padding: 2px 6px;">Sell</MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudItem>
</MudGrid>
}

<!-- Quick Order Drawer Component -->
<QuickOrderDrawer @ref="_drawerRef" @bind-IsOpen="_drawerOpen" Ticker="@_orderTicker" StockName="@_orderStockName"
    Action="@_orderAction" AccountAlias="@_orderAccountAlias" Exchange="@_orderExchange" Currency="@_orderCurrency"
    HoldingQty="@_orderHoldingQty" AvgPrice="@_orderAvgPrice" CurrentPrice="@_orderCurrentPrice"
    UnrealizedPnL="@_orderUnrealizedPnL" ReturnRate="@_orderReturnRate" OnOrderPlaced="@HandleOrderPlaced" />

@code {
    [Parameter]
    public string? AccountAlias { get; set; }

    private Account? account;
    private IEnumerable<Account> _availableAccounts = new List<Account>();

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();

        if (string.IsNullOrEmpty(AccountAlias) && _availableAccounts.Any())
        {
            AccountAlias = _availableAccounts.First().Alias;
        }

        if (!string.IsNullOrEmpty(AccountAlias))
        {
            await LoadAccountData(AccountAlias);
        }
    }

    private async Task LoadAccounts()
    {
        _availableAccounts = await AccountCacheService.GetAccountsAsync();

        // Auto-select first account if none selected and list was empty before
        if (string.IsNullOrEmpty(AccountAlias) && _availableAccounts.Any())
        {
            AccountAlias = _availableAccounts.First().Alias;
            await LoadAccountData(AccountAlias);
        }
    }

    private async Task OnAccountChanged(string alias)
    {
        AccountAlias = alias;
        NavigationManager.NavigateTo($"/assets/{alias}"); // Update URL
        await LoadAccountData(alias);
    }

    private async Task LoadAccountData(string alias)
    {
        account = await AssetService.GetAccountOverviewAsync(alias);
        if (account?.Positions != null)
        {
            var tickers = account.Positions.Values
            .SelectMany(list => list)
            .Select(p => p.Ticker)
            .Distinct();
            _stockNames = await StockService.GetStockNamesAsync(tickers);
        }
    }

    private Dictionary<string, string> _stockNames = new();

    private string GetStockName(string ticker)
    {
        return _stockNames.TryGetValue(ticker, out var name) ? name : "-";
    }

    private string GetColorStyle(decimal value)
    {
        if (value > 0) return "color: red;";
        if (value < 0) return "color: blue;";
        return "";
    }


    private decimal GetReturnRate(yQuant.Core.Models.Position pos)
    {
        if (pos.AvgPrice == 0) return 0;
        return (pos.CurrentPrice - pos.AvgPrice) / pos.AvgPrice * 100;
    }

    // Drawer state
    private bool _drawerOpen = false;
    private string _orderTicker = "";
    private string _orderStockName = "";
    private OrderAction _orderAction = OrderAction.Buy;
    private string _orderAccountAlias = "";
    private ExchangeCode _orderExchange = ExchangeCode.KOSPI;
    private CurrencyType _orderCurrency = CurrencyType.KRW;

    // Position details
    private decimal _orderHoldingQty = 0;
    private decimal _orderAvgPrice = 0;
    private decimal _orderCurrentPrice = 0;
    private decimal _orderUnrealizedPnL = 0;
    private decimal _orderReturnRate = 0;

    private void OpenQuickOrderDrawer(yQuant.Core.Models.Position position, OrderAction action)
    {
        _orderTicker = position.Ticker;
        _orderStockName = GetStockName(position.Ticker);
        _orderAction = action;
        _orderAccountAlias = position.AccountAlias;
        _orderExchange = position.Exchange ?? ExchangeCode.KOSPI;
        _orderCurrency = position.Currency;

        // Position details
        _orderHoldingQty = position.Qty;
        _orderAvgPrice = position.AvgPrice;
        _orderCurrentPrice = position.CurrentPrice;
        _orderUnrealizedPnL = position.UnrealizedPnL;
        _orderReturnRate = GetReturnRate(position);

        _drawerOpen = true;
    }

    private QuickOrderDrawer? _drawerRef;

    private async Task HandleOrderPlaced()
    {
        try
        {
            var quantity = _drawerRef?.GetQuantity() ?? 1;

            var order = new Order
                {
                    AccountAlias = _orderAccountAlias,
                    Ticker = _orderTicker,
                    Exchange = _orderExchange,
                    Currency = _orderCurrency,
                    Action = _orderAction,
                    Qty = quantity,
                    Price = 0, // Market order
                    Type = OrderType.Market
                };

            await OrderPublisher.PublishOrderAsync(order);
            Snackbar.Add($"Order placed: {_orderAction} {quantity} {_orderTicker}", Severity.Success);

            _drawerOpen = false;

            // Refresh account data
            if (!string.IsNullOrEmpty(AccountAlias))
            {
                await LoadAccountData(AccountAlias);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Order failed: {ex.Message}", Severity.Error);
        }
    }
}