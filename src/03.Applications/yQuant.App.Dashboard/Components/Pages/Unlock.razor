@page "/unlock"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Authentication.Cookies
@using System.Security.Claims
@using yQuant.App.Dashboard.Services
@inject NavigationManager Navigation
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration


<PageTitle>Unlock - yQuant</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
    <MudPaper Elevation="3" Class="pa-8">
        <form id="unlockForm" action="/account/unlock" method="post">
            <MudStack Spacing="4">
                <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
                    <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Class="mr-2" />
                    Unlock
                </MudText>

                @if (!string.IsNullOrEmpty(ErrorFromQuery))
                {
                    <MudAlert Severity="Severity.Error" Variant="Variant.Filled">
                        @ErrorFromQuery
                    </MudAlert>
                }

                <MudStack Spacing="3">
                    <MudTextField T="string" Label="PIN" InputType="InputType.Password" Required="true" Variant="Variant.Outlined"
                        Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Key"
                        HelperText="Enter your 4-digit PIN" MaxLength="4" id="pinInput" name="pin" autocomplete="off" />

                    <input type="hidden" name="returnUrl" value="@ReturnUrl" />

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Size="Size.Large"
                        ButtonType="ButtonType.Submit">
                        <MudIcon Icon="@Icons.Material.Filled.LockOpen" Class="mr-2" />
                        <span>Unlock</span>
                    </MudButton>
                </MudStack>
            </MudStack>
        </form>
    </MudPaper>
</MudContainer>

@code {
    [SupplyParameterFromQuery(Name = "returnUrl")]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery(Name = "error")]
    private string? ErrorFromQuery { get; set; }



    protected override void OnInitialized()
    {
        var pathBase = Configuration.GetValue<string>("Dashboard:PathBase")?.TrimEnd('/') ?? "";
        if (string.IsNullOrWhiteSpace(ReturnUrl) || ReturnUrl == "/")
        {
            ReturnUrl = string.IsNullOrWhiteSpace(pathBase) ? "/" : pathBase;
        }
    }
}
