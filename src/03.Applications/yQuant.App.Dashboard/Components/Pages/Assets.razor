@page "/assets"
@page "/assets/{AccountAlias}"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

@using yQuant.Core.Models

@using yQuant.App.Dashboard.Services
@using yQuant.Core.Ports.Output.Infrastructure
@inject AssetService AssetService
@inject AccountCacheService AccountCacheService
@inject StockService StockService
@inject NavigationManager NavigationManager
@inject OrderPublisher OrderPublisher
@inject ISnackbar Snackbar
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration

<AccountSelector Accounts="_availableAccounts" SelectedAccountAlias="@AccountAlias"
    SelectedAccountAliasChanged="@OnAccountChanged" />


@if (account == null)
{
    @if (!string.IsNullOrEmpty(AccountAlias))
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudText>Please select an account.</MudText>
    }
}
else
{
    <MudGrid>
    <MudItem xs="12" sm="6" md="4">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Total Equity (KRW)</MudText>
                <MudText Typo="Typo.h4">@account.GetTotalEquity(CurrencyType.KRW).ToString("N0") KRW</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Total Equity (USD)</MudText>
                <MudText Typo="Typo.h4">@account.GetTotalEquity(CurrencyType.USD).ToString("N2") USD</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Account Info</MudText>
                <MudText><b>Alias:</b> @account.Alias</MudText>
                <MudText><b>Number:</b> @account.Number</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12">
        <MudText Typo="Typo.h5" GutterBottom="true" Class="mt-4">Deposits</MudText>
        <MudTable Items="@account.Deposits" Hover="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Currency</MudTh>
                <MudTh>Amount</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Currency">@context.Key</MudTd>
                <MudTd DataLabel="Amount">@context.Value.ToString("N2")</MudTd>
            </RowTemplate>
        </MudTable>
    </MudItem>

    <MudItem xs="12">
        <MudText Typo="Typo.h5" GutterBottom="true" Class="mt-4">Positions</MudText>
        <PositionTable Positions="@account.Positions.Values.SelectMany(list => list)" AccountAlias="@account.Alias"
            OnOrderCompleted="RefreshAccount" />
    </MudItem>
</MudGrid>
}

@code {
    [Parameter]
    public string? AccountAlias { get; set; }

    private Account? account;
    private IEnumerable<Account> _availableAccounts = new List<Account>();

    @inject UiStateService UiStateService

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();

        if (string.IsNullOrEmpty(AccountAlias))
        {
            if (!string.IsNullOrEmpty(UiStateService.SelectedAccountAlias))
            {
                AccountAlias = UiStateService.SelectedAccountAlias;
                // Navigate to properly reflect the state in URL
                var pathBase = Configuration.GetValue<string>("Dashboard:PathBase")?.TrimEnd('/') ?? "";
                NavigationManager.NavigateTo($"{pathBase}/assets/{AccountAlias}", replace: true);
            }
            else if (_availableAccounts.Any())
            {
                AccountAlias = _availableAccounts.First().Alias;
                UiStateService.SetAccount(AccountAlias);
            }
        }
        else
        {
            UiStateService.SetAccount(AccountAlias);
        }

        if (!string.IsNullOrEmpty(AccountAlias))
        {
            await LoadAccountData(AccountAlias);
        }
    }

    private async Task LoadAccounts()
    {
        _availableAccounts = await AccountCacheService.GetAccountsAsync();
        // Fallback logic moved to OnInitializedAsync
    }

    private async Task OnAccountChanged(string alias)
    {
        AccountAlias = alias;
        UiStateService.SetAccount(alias);
        var pathBase = Configuration.GetValue<string>("Dashboard:PathBase")?.TrimEnd('/') ?? "";
        NavigationManager.NavigateTo($"{pathBase}/assets/{alias}"); // Update URL
        await LoadAccountData(alias);
    }

    private async Task LoadAccountData(string alias)
    {
        account = await AssetService.GetAccountOverviewAsync(alias);
        // Stock names are now handled within PositionTable component
    }

    private async Task RefreshAccount()
    {
        // Wait a moment for BrokerGateway to update Valkey
        await Task.Delay(500);

        if (!string.IsNullOrEmpty(AccountAlias))
        {
            await LoadAccountData(AccountAlias);
            StateHasChanged();
        }
    }
}