@page "/assets"
@page "/assets/{AccountAlias}"

@using yQuant.Core.Models

@using yQuant.App.Dashboard.Services
@using yQuant.Core.Ports.Output.Infrastructure
@inject AssetService AssetService
@inject StockService StockService
@inject NavigationManager NavigationManager

<MudText Typo="Typo.h4" GutterBottom="true">Asset Summary</MudText>

<MudSelect T="string" Label="Select Account" Value="@AccountAlias" ValueChanged="OnAccountChanged"
    Variant="Variant.Outlined" Class="mb-4">
    @foreach (var acc in _availableAccounts)
    {
        <MudSelectItem Value="@acc.Alias">@acc.Alias (@acc.Broker)</MudSelectItem>
    }
    </MudSelect>

    @if (account == null)
{
    @if (!string.IsNullOrEmpty(AccountAlias))
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else
    {
        <MudText>Please select an account.</MudText>
    }
}
else
{
    <MudGrid>
    <MudItem xs="12" sm="6" md="4">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Total Equity (KRW)</MudText>
                <MudText Typo="Typo.h4">@account.GetTotalEquity(CurrencyType.KRW).ToString("N0") KRW</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Total Equity (USD)</MudText>
                <MudText Typo="Typo.h4">@account.GetTotalEquity(CurrencyType.USD).ToString("N2") USD</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>
    <MudItem xs="12" sm="6" md="4">
        <MudCard>
            <MudCardContent>
                <MudText Typo="Typo.h6">Account Info</MudText>
                <MudText><b>Alias:</b> @account.Alias</MudText>
                <MudText><b>Number:</b> @account.Number</MudText>
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12">
        <MudText Typo="Typo.h5" GutterBottom="true" Class="mt-4">Deposits</MudText>
        <MudTable Items="@account.Deposits" Hover="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Currency</MudTh>
                <MudTh>Amount</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Currency">@context.Key</MudTd>
                <MudTd DataLabel="Amount">@context.Value.ToString("N2")</MudTd>
            </RowTemplate>
        </MudTable>
    </MudItem>

    <MudItem xs="12">
        <MudText Typo="Typo.h5" GutterBottom="true" Class="mt-4">Positions</MudText>
        <MudTable Items="@account.Positions" Hover="true" Breakpoint="Breakpoint.Sm">
            <HeaderContent>
                <MudTh>Ticker</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Currency</MudTh>
                <MudTh>Qty</MudTh>
                <MudTh>Avg Price</MudTh>
                <MudTh>Cur Price</MudTh>
                <MudTh>PnL</MudTh>
                <MudTh>Return %</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Ticker">@context.Ticker</MudTd>
                <MudTd DataLabel="Name">@GetStockName(context.Ticker)</MudTd>
                <MudTd DataLabel="Currency">@context.Currency</MudTd>
                <MudTd DataLabel="Qty">@context.Qty</MudTd>
                <MudTd DataLabel="Avg Price">@context.AvgPrice.ToString("N2")</MudTd>
                <MudTd DataLabel="Cur Price">@context.CurrentPrice.ToString("N2")</MudTd>
                <MudTd DataLabel="PnL" Style="@GetColorStyle(context.UnrealizedPnL)">
                    @context.UnrealizedPnL.ToString("N2")</MudTd>
                <MudTd DataLabel="Return %" Style="@GetColorStyle(context.UnrealizedPnL)">
                    @GetReturnRate(context).ToString("F2")%</MudTd>
            </RowTemplate>
        </MudTable>
    </MudItem>
</MudGrid>
}

@code {
    [Parameter]
    public string? AccountAlias { get; set; }

    private Account? account;
    private IEnumerable<Account> _availableAccounts = new List<Account>();

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();

        if (string.IsNullOrEmpty(AccountAlias) && _availableAccounts.Any())
        {
            AccountAlias = _availableAccounts.First().Alias;
        }

        if (!string.IsNullOrEmpty(AccountAlias))
        {
            await LoadAccountData(AccountAlias);
        }
    }

    private async Task LoadAccounts()
    {
        var aliases = await AssetService.GetAvailableAccountsAsync();
        var accounts = new List<Account>();
        foreach (var alias in aliases)
        {
            var account = AssetService.GetAccountBasicInfo(alias);
            if (account != null)
            {
                accounts.Add(account);
            }
        }
        _availableAccounts = accounts;

        // Auto-select first account if none selected and list was empty before
        if (string.IsNullOrEmpty(AccountAlias) && _availableAccounts.Any())
        {
            AccountAlias = _availableAccounts.First().Alias;
            await LoadAccountData(AccountAlias);
        }
    }

    private async Task OnAccountChanged(string alias)
    {
        AccountAlias = alias;
        NavigationManager.NavigateTo($"/assets/{alias}"); // Update URL
        await LoadAccountData(alias);
    }

    private async Task LoadAccountData(string alias)
    {
        account = await AssetService.GetAccountOverviewAsync(alias);
        if (account?.Positions != null)
        {
            var tickers = account.Positions.Select(p => p.Ticker);
            _stockNames = await StockService.GetStockNamesAsync(tickers);
        }
    }

    private Dictionary<string, string> _stockNames = new();

    private string GetStockName(string ticker)
    {
        return _stockNames.TryGetValue(ticker, out var name) ? name : "-";
    }

    private string GetColorStyle(decimal value)
    {
        if (value > 0) return "color: red;";
        if (value < 0) return "color: blue;";
        return "";
    }

    private decimal GetReturnRate(yQuant.Core.Models.Position pos)
    {
        if (pos.AvgPrice == 0) return 0;
        return (pos.CurrentPrice - pos.AvgPrice) / pos.AvgPrice * 100;
    }
}