@page "/trades"
@page "/trades/{AccountAlias}"
@using yQuant.Core.Models
@using yQuant.Core.Ports.Output.Infrastructure
@using yQuant.App.Dashboard.Services
@inject ITradeRepository TradeRepository
@inject ILogger<TradeHistory> Logger
@inject AccountCacheService AccountCacheService
@inject NavigationManager NavigationManager
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@attribute [Microsoft.AspNetCore.Authorization.Authorize]

<AccountSelector Accounts="_availableAccounts" SelectedAccountAlias="@AccountAlias"
    SelectedAccountAliasChanged="@OnAccountChanged" />

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudGrid>
        <MudItem xs="12" sm="6" md="6">
            <MudDatePicker Label="Start Date" @bind-Date="_startDate" Variant="Variant.Outlined" FullWidth />
        </MudItem>
        <MudItem xs="12" sm="6" md="6">
            <MudDatePicker Label="End Date" @bind-Date="_endDate" Variant="Variant.Outlined" FullWidth />
        </MudItem>
    </MudGrid>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadTrades" Class="mt-2 mb-4"
        Disabled="_loading">
        @if (_loading)
        {
            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            <span>Loading...</span>
        }
        else
        {
            <span>Load Trades</span>
        }
    </MudButton>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else if (_trades.Any())
    {
        <MudPaper>
            <MudTable Items="@_trades" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                <HeaderContent>
                    <MudTh>Date/Time</MudTh>
                    <MudTh>Ticker</MudTh>
                    <MudTh>Action</MudTh>
                    <MudTh Style="text-align:right">Quantity</MudTh>
                    <MudTh Style="text-align:right">Price</MudTh>
                    <MudTh Style="text-align:right">Amount</MudTh>
                    <MudTh Style="text-align:right">Commission</MudTh>
                    <MudTh>Strategy</MudTh>
                    <MudTh>Exchange</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Date/Time">
                        <MudText Typo="Typo.body2">@context.ExecutedAt.ToLocalTime().ToString("yyyy-MM-dd")</MudText>
                        <MudText Typo="Typo.caption">@context.ExecutedAt.ToLocalTime().ToString("HH:mm:ss")</MudText>
                    </MudTd>
                    <MudTd DataLabel="Ticker">
                        <MudText Typo="Typo.body2" Style="font-weight:500">@context.Ticker</MudText>
                    </MudTd>
                    <MudTd DataLabel="Action">
                        <MudChip T="string" Size="Size.Small"
                            Color="@(context.Action == OrderAction.Buy ? Color.Success : Color.Error)">
                            @context.Action
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Quantity" Style="text-align:right">
                        @context.Quantity.ToString("N0")
                    </MudTd>
                    <MudTd DataLabel="Price" Style="text-align:right">
                        @context.ExecutedPrice.ToString("N2")
                    </MudTd>
                    <MudTd DataLabel="Amount" Style="text-align:right">
                        <MudText Typo="Typo.body2" Style="font-weight:500">
                            @context.Amount.ToString("N2")
                        </MudText>
                    </MudTd>
                    <MudTd DataLabel="Commission" Style="text-align:right">
                        @context.Commission.ToString("N2")
                    </MudTd>
                    <MudTd DataLabel="Strategy">
                        <MudText Typo="Typo.caption">@(context.Strategy ?? "-")</MudText>
                        </MudTd>
                        <MudTd DataLabel="Exchange">
                            <MudText Typo="Typo.caption">@context.Exchange</MudText>
                        </MudTd>
                    </RowTemplate>
                    <PagerContent>
                        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
                    </PagerContent>
                </MudTable>
            </MudPaper>

        <MudPaper Class="pa-4 mt-4">
            <MudText Typo="Typo.h6" GutterBottom="true">Summary</MudText>
            <MudGrid>
                <MudItem xs="6" sm="3">
                    <MudText Typo="Typo.caption">Total Trades</MudText>
                    <MudText Typo="Typo.h6">@_trades.Count</MudText>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudText Typo="Typo.caption">Total Buy</MudText>
                    <MudText Typo="Typo.h6" Color="Color.Success">@_trades.Count(t => t.Action == OrderAction.Buy)</MudText>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudText Typo="Typo.caption">Total Sell</MudText>
                    <MudText Typo="Typo.h6" Color="Color.Error">@_trades.Count(t => t.Action == OrderAction.Sell)</MudText>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudText Typo="Typo.caption">Total Volume</MudText>
                    <MudText Typo="Typo.h6">@_trades.Sum(t => t.Amount).ToString("N2")</MudText>
                </MudItem>
            </MudGrid>
        </MudPaper>
    }
    else if (!_loading)
    {
        <MudAlert Severity="Severity.Info">No trades found for the selected period.</MudAlert>
    }
    </MudContainer>

    @code {
    [Parameter]
    public string? AccountAlias { get; set; }

    private IEnumerable<Account> _availableAccounts = new List<Account>();
    private List<TradeRecord> _trades = new();
    private DateTime? _startDate = DateTime.Today.AddDays(-30);
    private DateTime? _endDate = DateTime.Today;
    private bool _loading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();

        if (string.IsNullOrEmpty(AccountAlias) && _availableAccounts.Any())
        {
            AccountAlias = _availableAccounts.First().Alias;
        }

        if (!string.IsNullOrEmpty(AccountAlias))
        {
            await LoadTrades();
        }
    }

    private async Task LoadAccounts()
    {
        _availableAccounts = await AccountCacheService.GetAccountsAsync();
    }

    private async Task OnAccountChanged(string alias)
    {
        AccountAlias = alias;
        var pathBase = Configuration.GetValue<string>("Dashboard:PathBase")?.TrimEnd('/') ?? "";
        NavigationManager.NavigateTo($"{pathBase}/trades/{alias}");
        await LoadTrades();
    }

    private async Task LoadTrades()
    {
        if (string.IsNullOrEmpty(AccountAlias))
        {
            return;
        }

        _loading = true;
        try
        {
            var start = _startDate.HasValue ? DateOnly.FromDateTime(_startDate.Value) :
            DateOnly.FromDateTime(DateTime.Today.AddDays(-30));
            var end = _endDate.HasValue ? DateOnly.FromDateTime(_endDate.Value) : DateOnly.FromDateTime(DateTime.Today);

            var trades = await TradeRepository.GetTradesByRangeAsync(AccountAlias, start, end);
            _trades = trades.OrderByDescending(t => t.ExecutedAt).ToList();

            Logger.LogInformation("Loaded {Count} trades for {Account} from {Start} to {End}",
            _trades.Count, AccountAlias, start, end);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load trades for {Account}", AccountAlias);
            _trades = new();
        }
        finally
        {
            _loading = false;
        }
    }
}
