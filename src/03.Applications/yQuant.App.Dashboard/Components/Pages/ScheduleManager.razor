@page "/schedules"
@using yQuant.App.Dashboard.Services
@using yQuant.App.Dashboard.Models
@using yQuant.Core.Models
@using yQuant.Core.Ports.Output.Infrastructure
@inject SchedulerService SchedulerService
@inject AssetService AssetService
@inject StockService StockService
@inject ISnackbar Snackbar
@inject IJSRuntime JS

<PageTitle>Scheduled Orders</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Scheduled Orders</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudCard Outlined="true" Class="pa-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Add/Edit Scheduled Order</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudForm Model="@CurrentSchedule" @ref="@ScheduleForm" ValidationDelay="0">
                    <!-- Account -->
                    <MudSelect T="string" @bind-Value="CurrentSchedule.AccountAlias" Label="Account" Required="true"
                        RequiredError="Account is required!" Variant="Variant.Outlined">
                        @foreach (var account in AvailableAccounts)
                        {
                            <MudSelectItem T="string" Value="@account.Alias">@account.Alias (@account.Broker)
                            </MudSelectItem>
                        }
                    </MudSelect>

                    <!-- Ticker & Lookup -->
                    <MudTextField T="string" @bind-Value="CurrentSchedule.Ticker" Label="Ticker" Required="true"
                        RequiredError="Ticker is required!" Class="mt-3" OnBlur="LookupStock" Adornment="Adornment.End"
                        AdornmentIcon="@Icons.Material.Filled.Search" OnAdornmentClick="LookupStock" />

                    @if (!string.IsNullOrEmpty(StockName))
                    {
                        <div class="d-flex gap-2 mt-2 align-center">
                            <MudChip T="string" Color="Color.Info" Size="Size.Small">@StockName</MudChip>
                            <MudChip T="string" Color="Color.Default" Size="Size.Small">@CurrentSchedule.Exchange</MudChip>
                            <MudChip T="string" Color="Color.Default" Size="Size.Small">@CurrentSchedule.Currency</MudChip>
                        </div>
                    }

                    <!-- Action & Quantity -->
                    <div class="d-flex gap-4 mt-3">
                        <MudSelect T="OrderAction" @bind-Value="CurrentSchedule.Action" Label="Action" Required="true"
                            Variant="Variant.Outlined" Class="flex-grow-1">
                            <MudSelectItem T="OrderAction" Value="OrderAction.Buy">Buy</MudSelectItem>
                            <MudSelectItem T="OrderAction" Value="OrderAction.Sell">Sell</MudSelectItem>
                        </MudSelect>

                        <MudNumericField T="int?" @bind-Value="CurrentSchedule.Quantity" Label="Quantity"
                            Variant="Variant.Outlined" Min="1" Class="flex-grow-1" />
                    </div>

                    <!-- Days of Week -->
                    <MudText Typo="Typo.subtitle2" Class="mt-4">Run Days</MudText>
                    <div class="d-flex gap-2 mb-2">
                        <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="SelectWeekdays">Select Weekdays
                        </MudButton>
                        <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="ClearDays">Clear</MudButton>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var day in Enum.GetValues<DayOfWeek>().OrderBy(d => d == DayOfWeek.Sunday ? 7 :
                        (int)d))
                        {
                            <MudCheckBox T="bool" Label="@day.ToString()[..3]"
                                Value="@CurrentSchedule.DaysOfWeek.Contains(day)"
                                ValueChanged="@((bool c) => UpdateDay(day, c))" Dense="true" Color="Color.Primary" />
                        }
                    </div>
                    @if (!CurrentSchedule.DaysOfWeek.Any())
                    {
                        <MudText Typo="Typo.caption" Color="Color.Error">Select at least one day.</MudText>
                    }

                    <!-- Time & Mode -->
                    <div class="d-flex gap-4 mt-3">
                        <MudSelect T="ScheduleTimeMode" @bind-Value="CurrentSchedule.TimeMode" Label="Time Mode"
                            Class="flex-grow-1" Variant="Variant.Outlined">
                            <MudSelectItem T="ScheduleTimeMode" Value="ScheduleTimeMode.FixedTime">Fixed Time (UTC)
                            </MudSelectItem>
                            <MudSelectItem T="ScheduleTimeMode" Value="ScheduleTimeMode.AfterMarketOpen">After Market
                                Open</MudSelectItem>
                        </MudSelect>

                        <MudTimePicker
                            Label="@(CurrentSchedule.TimeMode == ScheduleTimeMode.FixedTime ? "Execution Time" : "Offset Time")"
                        @bind-Time="ScheduleTime" Class="flex-grow-1" Variant="Variant.Outlined" />
                    </div>
                    @if (CurrentSchedule.TimeMode == ScheduleTimeMode.AfterMarketOpen)
                    {
                        <MudText Typo="Typo.caption" Class="ml-1">Runs N hours:minutes AFTER market open.</MudText>
                    }

                    <MudTextField T="string" @bind-Value="CurrentSchedule.Notes" Label="Notes (Optional)" Lines="2"
                        Class="mt-3" Variant="Variant.Outlined" />

                    <MudCheckBox T="bool" @bind-Value="CurrentSchedule.IsActive" Label="Active" Class="mt-3"
                        Color="Color.Success" />
                </MudForm>
            </MudCardContent>
            <MudCardActions Class="justify-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveSchedule"
                    Disabled="@(!IsFormValid())">Save Schedule</MudButton>
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="ClearForm">Clear</MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudCard Outlined="true" Class="pa-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <div class="d-flex justify-space-between align-center">
                        <MudText Typo="Typo.h6">Existing Schedules</MudText>
                        <div class="d-flex gap-2">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                StartIcon="@Icons.Material.Filled.Download" OnClick="ExportOrders" Size="Size.Small">
                                Export</MudButton>
                            <InputFile id="importFile" OnChange="ImportOrders" hidden />
                            <MudButton HtmlTag="label" Variant="Variant.Filled" Color="Color.Secondary"
                                StartIcon="@Icons.Material.Filled.Upload" for="importFile" Size="Size.Small">Import
                            </MudButton>
                        </div>
                    </div>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (!_scheduledOrders.Any())
                {
                    <MudText>No scheduled orders found.</MudText>
                }
                else
                {
                    <MudList T="ScheduledOrder" Clickable="true">
                        @foreach (var schedule in _scheduledOrders.OrderBy(s => s.NextExecutionTime ?? DateTime.MaxValue))
                        {
                            <MudListItem T="ScheduledOrder" OnClick="@(() => EditSchedule(schedule))">
                                <div class="d-flex justify-space-between align-center">
                                    <div>
                                        <MudText><b>@schedule.Ticker</b> (@schedule.Action) x @(schedule.Quantity ?? 0)
                                        </MudText>
                                        <MudText Typo="Typo.body2">
                                            @string.Join(", ", schedule.DaysOfWeek.Select(d => d.ToString()[..3]))
                                            at @(schedule.TimeMode == ScheduleTimeMode.FixedTime ?
                                             schedule.TimeConfig.ToString(@"hh\:mm") : $"+{schedule.TimeConfig:hh\\:mm} Open")
                                        </MudText>
                                        <MudText Typo="Typo.caption">
                                            Next: @(schedule.NextExecutionTime?.ToLocalTime().ToString("g") ?? "Inactive")
                                        </MudText>
                                    </div>
                                    <div class="d-flex align-center">
                                        @if (!schedule.IsActive)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Default">Inactive</MudChip>
                                        }
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                            Size="Size.Small" OnClick="@(() => DeleteSchedule(schedule.Id))" />
                                    </div>
                                </div>
                            </MudListItem>
                            <MudDivider />
                        }
                    </MudList>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private MudForm? ScheduleForm;
    private ScheduledOrder CurrentSchedule = new() { AccountAlias = "", Ticker = "", Action = OrderAction.Buy };
    private IEnumerable<Account> AvailableAccounts = new List<Account>();
    private IEnumerable<ScheduledOrder> _scheduledOrders = new List<ScheduledOrder>();
    private string StockName = "";

    // Helper for TimePicker binding
    private TimeSpan? ScheduleTime
    {
        get => CurrentSchedule.TimeConfig;
        set => CurrentSchedule.TimeConfig = value ?? TimeSpan.Zero;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        SchedulerService.OnChange += OnSchedulerServiceChange;
    }

    private async Task LoadData()
    {
        var aliases = await AssetService.GetAvailableAccountsAsync();
        var accounts = new List<Account>();
        foreach (var alias in aliases)
        {
            var account = AssetService.GetAccountBasicInfo(alias);
            if (account != null) accounts.Add(account);
        }
        AvailableAccounts = accounts;
        _scheduledOrders = SchedulerService.GetScheduledOrders();

        if (AvailableAccounts.Any() && string.IsNullOrEmpty(CurrentSchedule.AccountAlias))
        {
            CurrentSchedule.AccountAlias = AvailableAccounts.First().Alias;
        }

        StateHasChanged();
    }

    private async void OnSchedulerServiceChange() => await InvokeAsync(LoadData);

    private async Task LookupStock()
    {
        if (string.IsNullOrWhiteSpace(CurrentSchedule.Ticker)) return;

        var info = await StockService.GetStockInfoAsync(CurrentSchedule.Ticker.ToUpper());
        if (info.HasValue)
        {
            CurrentSchedule.Ticker = CurrentSchedule.Ticker.ToUpper();
            StockName = info.Value.Name;
            CurrentSchedule.Exchange = info.Value.Exchange;
            CurrentSchedule.Currency = info.Value.Currency;
            Snackbar.Add($"Found: {StockName} ({CurrentSchedule.Exchange})", Severity.Success);
        }
        else
        {
            StockName = "";
            Snackbar.Add("Stock not found in master data.", Severity.Warning);
        }
    }

    private void UpdateDay(DayOfWeek day, bool isSelected)
    {
        if (isSelected) CurrentSchedule.DaysOfWeek.Add(day);
        else CurrentSchedule.DaysOfWeek.Remove(day);
    }

    private void SelectWeekdays()
    {
        CurrentSchedule.DaysOfWeek = new() { DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday,
DayOfWeek.Friday };
    }

    private void ClearDays() => CurrentSchedule.DaysOfWeek.Clear();

    private bool IsFormValid()
    {
        return !string.IsNullOrEmpty(CurrentSchedule.AccountAlias) &&
        !string.IsNullOrEmpty(CurrentSchedule.Ticker) &&
        CurrentSchedule.DaysOfWeek.Any() &&
        (CurrentSchedule.Quantity > 0);
    }

    private void ClearForm()
    {
        CurrentSchedule = new()
            {
                AccountAlias = AvailableAccounts.FirstOrDefault()?.Alias ?? "",
                Ticker = "",
                Action = OrderAction.Buy,
                DaysOfWeek = new(),
                TimeConfig = TimeSpan.FromHours(14.5) // Default to 14:30 (US Open)
            };
        StockName = "";
        ScheduleTime = TimeSpan.FromHours(14.5);

        ScheduleForm?.ResetValidation();
        StateHasChanged();
    }

    private async Task SaveSchedule()
    {
        await ScheduleForm!.Validate();
        if (ScheduleForm.IsValid && IsFormValid())
        {
            SchedulerService.AddOrUpdateScheduledOrder(CurrentSchedule);
            Snackbar.Add("Scheduled order saved!", Severity.Success);
            ClearForm();
        }
        else if (!CurrentSchedule.DaysOfWeek.Any())
        {
            Snackbar.Add("Please select at least one day.", Severity.Warning);
        }
    }

    private void EditSchedule(ScheduledOrder schedule)
    {
        CurrentSchedule = schedule; // Reference copy is risky if cancel, but acceptable for simple app
        ScheduleTime = schedule.TimeConfig;

        // Lookup stock name for display
        _ = LookupStock();

        StateHasChanged();
    }

    private void DeleteSchedule(Guid id)
    {
        SchedulerService.RemoveScheduledOrder(id);
        if (CurrentSchedule.Id == id) ClearForm();
        Snackbar.Add("Scheduled order deleted!", Severity.Success);
    }

    private async Task ExportOrders()
    {
        var json = SchedulerService.ExportOrders();
        var bytes = System.Text.Encoding.UTF8.GetBytes(json);
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", "scheduled_orders.json", base64);
    }

    private async Task ImportOrders(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            using var stream = file.OpenReadStream(1024 * 1024);
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();
            try
            {
                SchedulerService.ImportOrders(json);
                Snackbar.Add("Orders imported successfully!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Import failed: {ex.Message}", Severity.Error);
            }
        }
    }

    public void Dispose()
    {
        SchedulerService.OnChange -= OnSchedulerServiceChange;
    }
}
