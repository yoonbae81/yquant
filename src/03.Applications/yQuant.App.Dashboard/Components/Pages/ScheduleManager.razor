@page "/schedules"
@using yQuant.App.Dashboard.Services
@using yQuant.App.Dashboard.Models
@using yQuant.Core.Models
@using yQuant.Core.Ports.Output.Infrastructure
@inject SchedulerService SchedulerService
@inject AssetService AssetService
@inject ISnackbar Snackbar

<PageTitle>Scheduled Orders</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">Scheduled Orders</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudCard Outlined="true" Class="pa-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Add/Edit Scheduled Order</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudForm Model="@CurrentSchedule" @ref="@ScheduleForm" ValidationDelay="0">
                    <MudSelect T="string" @bind-Value="CurrentSchedule.AccountAlias" Label="Account" Required="true"
                        RequiredError="Account is required!" Variant="Variant.Outlined">
                        @foreach (var account in AvailableAccounts)
                        {
                                <MudSelectItem T="string" Value="@account.Alias">@account.Alias (@account.Broker)
                                </MudSelectItem>
                        }
                    </MudSelect>
                    <MudTextField T="string" @bind-Value="CurrentSchedule.Ticker" Label="Ticker" Required="true"
                        RequiredError="Ticker is required!" Class="mt-3" />
                    <MudSelect T="OrderAction" @bind-Value="CurrentSchedule.Action" Label="Action" Required="true"
                        RequiredError="Action is required!" Class="mt-3">
                        <MudSelectItem T="OrderAction" Value="OrderAction.Buy">Buy</MudSelectItem>
                        <MudSelectItem T="OrderAction" Value="OrderAction.Sell">Sell</MudSelectItem>
                    </MudSelect>
                    <MudNumericField T="decimal" @bind-Value="CurrentSchedule.TargetAmount" Label="Target Amount"
                        Variant="Variant.Text" Min="0" Step="1000" Class="mt-3" />
                    <MudNumericField T="int?" @bind-Value="CurrentSchedule.Quantity" Label="Quantity (Optional)"
                        Variant="Variant.Text" Min="0" Class="mt-3" />
                    <MudDatePicker @bind-Date="ScheduleDate" Label="Schedule Date" Class="mt-3" />
                    <MudTimePicker @bind-Time="ScheduleTime" Label="Schedule Time" Class="mt-3" />
                    <MudCheckBox T="bool" @bind-Value="CurrentSchedule.IsRecurring" Label="Recurring" Class="mt-3" />
                    @if (CurrentSchedule.IsRecurring)
                    {
                            <MudSelect T="string" @bind-Value="CurrentSchedule.RecurrencePattern" Label="Recurrence Pattern"
                                Class="mt-3">
                                <MudSelectItem T="string" Value="@("Daily")">Daily</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Weekly")">Weekly</MudSelectItem>
                            </MudSelect>
                    }
                    <MudTextField T="string" @bind-Value="CurrentSchedule.Notes" Label="Notes (Optional)" Lines="3"
                        Class="mt-3" />
                    <MudCheckBox T="bool" @bind-Value="CurrentSchedule.IsActive" Label="Active" Class="mt-3" />
                </MudForm>
            </MudCardContent>
            <MudCardActions Class="justify-end">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveSchedule"
                    Disabled="@(!ScheduleForm?.IsValid ?? true)">Save Schedule</MudButton>
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="ClearForm">Clear</MudButton>
            </MudCardActions>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudCard Outlined="true" Class="pa-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <div class="d-flex justify-space-between align-center">
                        <MudText Typo="Typo.h6">Existing Schedules</MudText>
                        <div class="d-flex gap-2">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                                StartIcon="@Icons.Material.Filled.Download" OnClick="ExportOrders" Size="Size.Small">
                                Export</MudButton>
                            <InputFile id="importFile" OnChange="ImportOrders" hidden />
                            <MudButton HtmlTag="label" Variant="Variant.Filled" Color="Color.Secondary"
                                StartIcon="@Icons.Material.Filled.Upload" for="importFile" Size="Size.Small">Import
                            </MudButton>
                        </div>
                    </div>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (!_scheduledOrders.Any())
                {
                        <MudText>No scheduled orders found.</MudText>
                }
                else
                {
                        <MudList T="ScheduledOrder">
                        @foreach (var schedule in _scheduledOrders.OrderBy(s => s.ScheduledTime))
                        {
                                    <MudListItem T="ScheduledOrder" OnClick="@(() => EditSchedule(schedule))">
                                        <div class="d-flex justify-space-between align-center">
                                            <div>
                                                <MudText>@schedule.Ticker (@schedule.Action) -
                                            @schedule.ScheduledTime.ToLocalTime().ToString("g")</MudText>
                                                <MudText Typo="Typo.caption">Account: @schedule.AccountAlias, Active: @schedule.IsActive
                                            @(schedule.IsRecurring ? $"({schedule.RecurrencePattern})" : "")</MudText>
                                                    </div>
                                                    <span @onclick:stopPropagation="true">
                                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                                            Size="Size.Small" OnClick="@(() => DeleteSchedule(schedule.Id))" />
                                                    </span>
                                                </div>
                                            </MudListItem>
                        }
                        </MudList>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

@code {
    private MudForm? ScheduleForm;
    private ScheduledOrder CurrentSchedule = new() { AccountAlias = "", Ticker = "", Action = OrderAction.Buy };
    private IEnumerable<Account> AvailableAccounts = new List<Account>();
    private IEnumerable<ScheduledOrder> _scheduledOrders = new List<ScheduledOrder>();

    private DateTime? ScheduleDate
    {
        get => CurrentSchedule.ScheduledTime.Date;
        set
        {
            if (value.HasValue)
            {
                CurrentSchedule.ScheduledTime = value.Value.Date + (ScheduleTime ?? TimeSpan.Zero);
            }
        }
    }

    private TimeSpan? ScheduleTime
    {
        get => CurrentSchedule.ScheduledTime.TimeOfDay;
        set
        {
            if (value.HasValue)
            {
                CurrentSchedule.ScheduledTime = CurrentSchedule.ScheduledTime.Date + value.Value;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
        SchedulerService.OnChange += OnSchedulerServiceChange;

    }

    private async Task LoadData()
    {
        var aliases = await AssetService.GetAvailableAccountsAsync();
        var accounts = new List<Account>();
        foreach (var alias in aliases)
        {
            var account = AssetService.GetAccountBasicInfo(alias);
            if (account != null)
            {
                accounts.Add(account);
            }
        }
        AvailableAccounts = accounts;
        _scheduledOrders = SchedulerService.GetScheduledOrders();

        if (AvailableAccounts.Any() && string.IsNullOrEmpty(CurrentSchedule.AccountAlias))
        {
            CurrentSchedule.AccountAlias = AvailableAccounts.First().Alias;
        }

        StateHasChanged(); // Refresh UI after data load
    }

    private async void OnSchedulerServiceChange()
    {
        // Re-load data and update UI when SchedulerService notifies of changes
        await LoadData();
    }



    private void ClearForm()
    {
        CurrentSchedule = new()
            {
                AccountAlias = AvailableAccounts.FirstOrDefault()?.Alias ?? "",
                Ticker = "",
                Action =
                OrderAction.Buy
            };
        ScheduleDate = null;
        ScheduleTime = null;
        if (AvailableAccounts.Any()) CurrentSchedule.AccountAlias = AvailableAccounts.First().Alias;
        ScheduleForm?.ResetValidation();
        Snackbar.Add("Form cleared.", Severity.Info);
        StateHasChanged();
    }

    private async Task SaveSchedule()
    {
        await ScheduleForm!.Validate();
        if (ScheduleForm.IsValid)
        {
            // Ensure ScheduledTime is valid (e.g., in the future)
            if (CurrentSchedule.ScheduledTime <= DateTime.UtcNow && CurrentSchedule.IsActive)
            {
                Snackbar.Add("Scheduled time must be in the future for active orders.", Severity.Warning);
                return;
            }

            SchedulerService.AddOrUpdateScheduledOrder(CurrentSchedule);
            Snackbar.Add("Scheduled order saved!", Severity.Success);
            ClearForm();
        }
    }

    private void EditSchedule(ScheduledOrder schedule)
    {
        CurrentSchedule = schedule;
        ScheduleDate = schedule.ScheduledTime.Date;
        ScheduleTime = schedule.ScheduledTime.TimeOfDay;
        StateHasChanged();
    }

    private void DeleteSchedule(Guid id)
    {
        SchedulerService.RemoveScheduledOrder(id);
        Snackbar.Add("Scheduled order deleted!", Severity.Success);
        ClearForm();
    }

    @inject IJSRuntime JS

    private async Task ExportOrders()
    {
        var json = SchedulerService.ExportOrders();
        var bytes = System.Text.Encoding.UTF8.GetBytes(json);
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", "scheduled_orders.json", base64);
    }

    private async Task ImportOrders(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            // Limit size to 1MB to prevent issues
            using var stream = file.OpenReadStream(1024 * 1024);
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();
            try
            {
                SchedulerService.ImportOrders(json);
                Snackbar.Add("Orders imported successfully!", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Import failed: {ex.Message}", Severity.Error);
            }
        }
    }

    public void Dispose()
    {
        SchedulerService.OnChange -= OnSchedulerServiceChange;

    }
}
