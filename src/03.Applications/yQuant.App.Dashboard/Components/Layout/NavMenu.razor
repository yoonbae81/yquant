@using yQuant.App.Dashboard.Services
@inject SystemHealthService HealthService
@implements IDisposable

<div style="display: flex; flex-direction: column; height: 100%;">
    <MudNavMenu>
        <MudNavLink Href="summary" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Summarize">Summary
        </MudNavLink>
        <MudNavLink Href="assets" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.AccountBalance">Assets
        </MudNavLink>
        <MudNavLink Href="scheduled" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Schedule">Scheduled
        </MudNavLink>
        <MudNavLink Href="orderform" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.ShoppingCart">Buy Order
        </MudNavLink>
        <MudNavLink Href="trades" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.History">Trade History
        </MudNavLink>
        <MudNavLink Href="performance" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.TrendingUp">Performance
        </MudNavLink>
        <MudNavLink Href="liquidate" Match="NavLinkMatch.Prefix" Icon="@Icons.Material.Filled.Sell">Liquidate
        </MudNavLink>

        <MudDivider Class="my-2" />

        <MudNavLink Href="lock" Icon="@Icons.Material.Filled.Lock">Lock Dashboard
        </MudNavLink>
    </MudNavMenu>

    <div style="margin-top: auto; padding: 16px 16px 8px 16px; font-size: 0.75rem; line-height: 1.5;">
        <div style="color: var(--mud-palette-text-secondary); margin-bottom: 4px; font-weight: 500;">Services Status
        </div>
        <div style="color: @(isMessageValkeyHealthy ? "limegreen" : "red")">• Valkey (Message)</div>
        <div style="color: @(isMariaDbHealthy ? "limegreen" : "red")">• MariaDB</div>
        <div style="color: @(isBrokerGatewayHealthy ? "limegreen" : "red")">• BrokerGateway</div>
        <div style="color: @(isOrderManagerHealthy ? "limegreen" : "red")">• OrderManager</div>
        <div style="color: @(isWebhookHealthy ? "limegreen" : "red")">• Webhook</div>
    </div>
</div>

@code {
    private bool isMessageValkeyHealthy = false;
    private bool isMariaDbHealthy = false;
    private bool isBrokerGatewayHealthy = false;
    private bool isOrderManagerHealthy = false;
    private bool isWebhookHealthy = false;

    private Timer? _timer;

    protected override void OnInitialized()
    {
        _timer = new Timer(async _ => await CheckHealthAsync(), null, TimeSpan.Zero, TimeSpan.FromSeconds(5));
    }

    private async Task CheckHealthAsync()
    {
        isMessageValkeyHealthy = await HealthService.CheckMessageValkeyAsync();
        isMariaDbHealthy = await HealthService.CheckMariaDbAsync();
        isBrokerGatewayHealthy = await HealthService.CheckServiceAsync("BrokerGateway");
        isOrderManagerHealthy = await HealthService.CheckServiceAsync("OrderManager");
        isWebhookHealthy = await HealthService.CheckServiceAsync("Webhook");

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}