@using yQuant.Core.Models
@using yQuant.App.Dashboard.Services
@inject NavigationManager NavigationManager
@inject OrderPublisher OrderPublisher
@inject ISnackbar Snackbar
@inject yQuant.App.Dashboard.Services.StockService StockService
@inject UiStateService UiState
@implements IDisposable

<MudTable Items="SortedPositions" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true" Elevation="0">
    <HeaderContent>
        <MudTh Style="cursor: pointer; user-select: none;" @onclick="@(() => HandleSort(PositionSortColumn.Ticker))">
            Ticker
            <MudIcon Icon="@GetSortIconName(PositionSortColumn.Ticker)"
                Color="@GetSortIconColor(PositionSortColumn.Ticker)" Size="Size.Small" />
        </MudTh>
        <MudTh Style="cursor: pointer; user-select: none;" @onclick="@(() => HandleSort(PositionSortColumn.Name))">
            Name
            <MudIcon Icon="@GetSortIconName(PositionSortColumn.Name)" Color="@GetSortIconColor(PositionSortColumn.Name)"
                Size="Size.Small" />
        </MudTh>
        <MudTh>Currency</MudTh>
        <MudTh Style="text-align: right; cursor: pointer; user-select: none;"
        @onclick="@(() => HandleSort(PositionSortColumn.Qty))">
            <MudIcon Icon="@GetSortIconName(PositionSortColumn.Qty)" Color="@GetSortIconColor(PositionSortColumn.Qty)"
                Size="Size.Small" /> Qty
        </MudTh>
        <MudTh Style="text-align: right; cursor: pointer; user-select: none;"
        @onclick="@(() => HandleSort(PositionSortColumn.CurrentPrice))">
            <MudIcon Icon="@GetSortIconName(PositionSortColumn.CurrentPrice)"
                Color="@GetSortIconColor(PositionSortColumn.CurrentPrice)" Size="Size.Small" /> Cur Price
        </MudTh>
        <MudTh Style="text-align: right; cursor: pointer; user-select: none;"
        @onclick="@(() => HandleSort(PositionSortColumn.TotalAmount))">
            <MudIcon Icon="@GetSortIconName(PositionSortColumn.TotalAmount)"
                Color="@GetSortIconColor(PositionSortColumn.TotalAmount)" Size="Size.Small" /> Total Amount
        </MudTh>
        <MudTh Style="text-align: right; cursor: pointer; user-select: none;"
        @onclick="@(() => HandleSort(PositionSortColumn.PnL))">
            <MudIcon Icon="@GetSortIconName(PositionSortColumn.PnL)" Color="@GetSortIconColor(PositionSortColumn.PnL)"
                Size="Size.Small" /> PnL
        </MudTh>
        <MudTh Style="text-align: right; cursor: pointer; user-select: none;"
        @onclick="@(() => HandleSort(PositionSortColumn.ReturnRate))">
            <MudIcon Icon="@GetSortIconName(PositionSortColumn.ReturnRate)"
                Color="@GetSortIconColor(PositionSortColumn.ReturnRate)" Size="Size.Small" /> Return %
        </MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Ticker">@context.Ticker</MudTd>
        <MudTd DataLabel="Name">@TruncateName(GetStockName(context.Ticker))</MudTd>
        <MudTd DataLabel="Currency">@context.Currency</MudTd>
        <MudTd DataLabel="Qty" Style="text-align: right;">@context.Qty.ToString("N0")</MudTd>
        <MudTd DataLabel="Cur Price" Style="text-align: right;">@context.CurrentPrice.ToString("N0")</MudTd>
        <MudTd DataLabel="Total Amount" Style="text-align: right;">@((context.Qty *
            context.CurrentPrice).ToString("N0"))</MudTd>
            <MudTd DataLabel="PnL"
                Style="@("text-align: right; " + (context.UnrealizedPnL >= 0 ? "color: green;" : "color: red;"))">
                @context.UnrealizedPnL.ToString("N0")
            </MudTd>
            <MudTd DataLabel="Return %"
                Style="@("text-align: right; " + (context.ChangeRate >= 0 ? "color: red;" : "color: blue;"))">
                @context.ChangeRate.ToString("N2")%
            </MudTd>
            <MudTd DataLabel="Actions">
                <MudButton OnClick="@(() => OpenQuickOrderDrawer(context, OrderAction.Buy))" Color="Color.Success"
                    Size="Size.Small" Variant="Variant.Outlined" Style="padding: 2px 6px;">Buy</MudButton>
                <MudButton OnClick="@(() => OpenQuickOrderDrawer(context, OrderAction.Sell))" Color="Color.Error"
                    Size="Size.Small" Variant="Variant.Outlined" Style="padding: 2px 6px;">Sell</MudButton>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText>No positions found for this account.</MudText>
        </NoRecordsContent>
    </MudTable>

    <!-- Quick Order Drawer Component -->
    <QuickOrderDrawer @ref="_drawerRef" @bind-IsOpen="_drawerOpen" Ticker="@_orderTicker" StockName="@_orderStockName"
        Action="@_orderAction" AccountAlias="@_orderAccountAlias" Exchange="@_orderExchange" Currency="@_orderCurrency"
        HoldingQty="@_orderHoldingQty" AvgPrice="@_orderAvgPrice" CurrentPrice="@_orderCurrentPrice"
        UnrealizedPnL="@_orderUnrealizedPnL" ReturnRate="@_orderReturnRate" OnOrderPlaced="@HandleOrderPlaced" />

    @code {
    [Parameter]
    public IEnumerable<yQuant.Core.Models.Position> Positions { get; set; } = new List<yQuant.Core.Models.Position>();

    [Parameter]
    public required string AccountAlias { get; set; }

    [Parameter]
    public EventCallback<(string ticker, OrderAction action, string accountAlias)> OnOrderAction { get; set; }

    [Parameter]
    public EventCallback OnOrderCompleted { get; set; }

    // Drawer state
    private bool _drawerOpen = false;
    private string _orderTicker = "";
    private string _orderStockName = "";
    private OrderAction _orderAction = OrderAction.Buy;
    private string _orderAccountAlias = "";
    private ExchangeCode _orderExchange = ExchangeCode.KOSPI;
    private CurrencyType _orderCurrency = CurrencyType.KRW;

    // Position details
    private decimal _orderHoldingQty = 0;
    private decimal _orderAvgPrice = 0;
    private decimal _orderCurrentPrice = 0;
    private decimal _orderUnrealizedPnL = 0;
    private decimal _orderReturnRate = 0;

    private QuickOrderDrawer? _drawerRef;
    private Dictionary<string, string> _stockNames = new();

    private IEnumerable<yQuant.Core.Models.Position> SortedPositions => SortPositions(Positions);

    protected override void OnInitialized()
    {
        UiState.OnChange += StateHasChanged;
    }

    public void Dispose()
    {
        UiState.OnChange -= StateHasChanged;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Load stock names for all positions
        if (Positions == null) return;
        var tickers = Positions.Where(p => !string.IsNullOrWhiteSpace(p.Ticker)).Select(p => p.Ticker.Trim()).Distinct();
        _stockNames = await StockService.GetStockNamesAsync(tickers);
    }

    private IEnumerable<yQuant.Core.Models.Position> SortPositions(IEnumerable<yQuant.Core.Models.Position> positions)
    {
        if (positions == null) return Enumerable.Empty<yQuant.Core.Models.Position>();

        var query = positions.AsQueryable();

        query = UiState.SortColumn switch
        {
            PositionSortColumn.Ticker => UiState.SortDescending ? query.OrderByDescending(p => p.Ticker) : query.OrderBy(p =>
            p.Ticker),
            PositionSortColumn.Name => UiState.SortDescending ? query.OrderByDescending(p => GetStockName(p.Ticker)) :
            query.OrderBy(p => GetStockName(p.Ticker)),
            PositionSortColumn.Currency => UiState.SortDescending ? query.OrderByDescending(p => p.Currency) : query.OrderBy(p =>
            p.Currency),
            PositionSortColumn.Qty => UiState.SortDescending ? query.OrderByDescending(p => p.Qty) : query.OrderBy(p => p.Qty),
            PositionSortColumn.CurrentPrice => UiState.SortDescending ? query.OrderByDescending(p => p.CurrentPrice) :
            query.OrderBy(p => p.CurrentPrice),
            PositionSortColumn.TotalAmount => UiState.SortDescending ? query.OrderByDescending(p => p.Qty * p.CurrentPrice) :
            query.OrderBy(p => p.Qty * p.CurrentPrice),
            PositionSortColumn.PnL => UiState.SortDescending ? query.OrderByDescending(p => p.UnrealizedPnL) : query.OrderBy(p =>
            p.UnrealizedPnL),
            PositionSortColumn.ReturnRate => UiState.SortDescending ? query.OrderByDescending(p => p.ChangeRate) : query.OrderBy(p
            => p.ChangeRate),
            _ => query.OrderByDescending(p => p.UnrealizedPnL)
        };

        return query.ToList();
    }

    private void HandleSort(PositionSortColumn column)
    {
        if (UiState.SortColumn == column)
        {
            UiState.SetPositionSort(column, !UiState.SortDescending);
        }
        else
        {
            // Default sort direction for new column
            bool defaultDescending = column != PositionSortColumn.Ticker && column != PositionSortColumn.Name;
            UiState.SetPositionSort(column, defaultDescending);
        }
    }



    // Better helper for icon
    private string GetSortIconName(PositionSortColumn column)
    {
        if (UiState.SortColumn != column) return Icons.Material.Filled.UnfoldMore; // Or empty/transparent
        return UiState.SortDescending ? Icons.Material.Filled.ArrowDownward : Icons.Material.Filled.ArrowUpward;
    }

    private Color GetSortIconColor(PositionSortColumn column)
    {
        return UiState.SortColumn == column ? Color.Primary : Color.Default;
    }

    private void OpenQuickOrderDrawer(yQuant.Core.Models.Position position, OrderAction action)
    {
        _orderTicker = position.Ticker;
        _orderStockName = GetStockName(position.Ticker);
        _orderAction = action;
        _orderAccountAlias = position.AccountAlias;
        _orderExchange = position.Exchange ?? ExchangeCode.KOSPI;
        _orderCurrency = position.Currency;

        // Position details
        _orderHoldingQty = position.Qty;
        _orderAvgPrice = position.AvgPrice;
        _orderCurrentPrice = position.CurrentPrice;
        _orderUnrealizedPnL = position.UnrealizedPnL;
        _orderReturnRate = GetReturnRate(position);

        _drawerOpen = true;
    }

    private async Task HandleOrderPlaced()
    {
        try
        {
            var quantity = _drawerRef?.GetQuantity() ?? 1;

            var order = new Order
                {
                    AccountAlias = _orderAccountAlias,
                    Ticker = _orderTicker,
                    Exchange = _orderExchange,
                    Currency = _orderCurrency,
                    Action = _orderAction,
                    Qty = quantity,
                    Price = 0, // Market order
                    Type = OrderType.Market
                };

            await OrderPublisher.PublishOrderAsync(order);
            Snackbar.Add($"Order placed: {_orderAction} {quantity} {_orderTicker}", Severity.Success);

            _drawerOpen = false;
            await OnOrderCompleted.InvokeAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Order failed: {ex.Message}", Severity.Error);
        }
    }

    private string GetStockName(string ticker)
    {
        if (string.IsNullOrWhiteSpace(ticker)) return "-";
        return _stockNames.TryGetValue(ticker.Trim(), out var name) ? name : "-";
    }

    private string TruncateName(string name)
    {
        return name.Length > 20 ? name.Substring(0, 20) : name;
    }

    private decimal GetReturnRate(yQuant.Core.Models.Position pos)
    {
        if (pos.AvgPrice == 0) return 0;
        return (pos.CurrentPrice - pos.AvgPrice) / pos.AvgPrice * 100;
    }
}
