# /etc/haproxy/haproxy.cfg
# yq-port ì„œë²„ìš© HAProxy ì„¤ì • ì˜ˆì‹œ

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    daemon

    maxconn 4096

    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull

    timeout connect 5s
    timeout client  30s
    timeout server  30s

    option  forwardfor
    option  http-server-close

# ğŸ“Š HAProxy Stats Dashboard (Internal Only)
# Access via: http://<yq-port-ip>:9000/stats
listen stats
    bind *:9000
    acl is_tailscale src 100.0.0.0/8
    http-request deny if !is_tailscale
    
    stats enable
    stats uri /stats
    stats refresh 10s

frontend http_in
    bind *:80
    http-request redirect scheme https code 301

frontend https_in
    bind *:443 ssl crt /etc/haproxy/certs/
    
    acl host_www hdr(host) -i yquant.xcv.kr
    acl is_webhook path_beg /webhook
    acl is_demo path_beg /demo

    use_backend webhook_nodes if host_www is_webhook
    use_backend demo_nodes if host_www is_demo

    # WebSocket ë° ê¸´ ì—°ê²° ì§€ì›
    option http-server-close
    option forwardfor

backend demo_nodes
    server localhost 127.0.0.1:5000 check

backend webhook_nodes
    balance source
    # [Active] <yq-blue-private-ip> ë˜ëŠ” Tailscale IP ì£¼ì†Œ ì…ë ¥
    server blue <yq-blue-private-ip>:6000 check
    
    # [Standby] ìŠ¤ìœ„ì¹­ ì‹œ backup í‚¤ì›Œë“œë¥¼ ì œê±°í•˜ì—¬ í™œì„±í™”
    server green <yq-green-private-ip>:6000 check backup
