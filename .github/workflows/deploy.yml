name: Deploy yQuant Worker

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy All Services to GREEN
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ”— Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          args: --accept-dns=false

      - name: âœ… Verify Tailscale Connection
        run: |
          echo "Checking Tailscale status..."
          tailscale status
          echo "---"
          echo "Tailscale IP:"
          tailscale ip -4

      - name: ğŸ” Resolve Target Host IP
        id: resolve-host
        run: |
          echo "Resolving Tailscale IP for ${{ secrets.HOST_GREEN }}..."
          echo "---"
          echo "Full Tailscale Status:"
          tailscale status
          echo "---"
          
          # Try multiple patterns to find the host
          TARGET_IP=$(tailscale status | grep -E "(yq-green|${{ secrets.HOST_GREEN }})" | head -1 | awk '{print $1}')
          
          if [ -z "$TARGET_IP" ]; then
            echo "âŒ Could not resolve target host IP"
            echo ""
            echo "âš ï¸  TROUBLESHOOTING:"
            echo "The target host 'yq-green' is not visible in the Tailscale network."
            echo "This usually means:"
            echo "  1. The target server is not connected to Tailscale"
            echo "  2. The TS_AUTHKEY doesn't have permission to see tagged devices"
            echo "  3. ACL rules are blocking visibility"
            echo ""
            echo "Please check:"
            echo "  - Is yq-green online and connected to Tailscale?"
            echo "  - Does the GitHub Actions authkey have 'tagged-devices' visibility in ACL?"
            echo "  - Generate a new authkey with proper tag permissions if needed"
            exit 1
          fi
          
          echo "âœ… Resolved IP: $TARGET_IP"
          echo "ip=$TARGET_IP" >> $GITHUB_OUTPUT

      - name: ğŸ” Test Connection to Target
        run: |
          echo "Testing connection to ${{ steps.resolve-host.outputs.ip }}..."
          for i in {1..3}; do
            if tailscale ping -c 1 ${{ steps.resolve-host.outputs.ip }}; then
              echo "âœ… Connection successful!"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 3
          done
          echo "âš ï¸ Ping failed after 3 attempts, but will try SSH anyway"

      - name: ğŸš€ Deploy via Tailscale SSH
        run: |
          tailscale ssh ${{ secrets.SSH_USER }}@${{ steps.resolve-host.outputs.ip }} << 'EOF'
            cd ~/yquant
            git fetch --all
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}
            bash scripts/deploy.sh
          EOF
      
      - name: ğŸ¥ Health Check
        run: |
          tailscale ssh ${{ secrets.SSH_USER }}@${{ steps.resolve-host.outputs.ip }} "cd ~/yquant && bash scripts/health-check.sh"
      
      - name: ğŸ“¢ Notify Success
        if: success()
        run: |
          echo "âœ… yQuant Deployment to GREEN successful!"
          echo "Ref: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: ğŸ“¢ Notify Failure
        if: failure()
        run: |
          echo "âŒ yQuant Deployment to GREEN failed!"
          echo "Check the logs above for details."
