name: Deploy yQuant Worker

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy All Services to GREEN
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”— Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          args: --accept-dns=true

      - name: âœ… Verify Tailscale Connection
        run: |
          echo "Checking Tailscale status..."
          tailscale status
          echo "---"
          echo "Tailscale IP:"
          tailscale ip -4

      - name: ðŸ”Ž Test Connection to Target
        run: |
          echo "Testing connection to ${{ secrets.HOST_GREEN }}..."
          tailscale ping -c 3 ${{ secrets.HOST_GREEN }} || echo "Ping failed, but will try SSH anyway"

      - name: ðŸš€ Deploy via Tailscale SSH
        run: |
          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.HOST_GREEN }} << 'EOF'
            cd ~/yquant
            git fetch --all
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}
            bash scripts/deploy.sh
          EOF
      
      - name: ðŸ¥ Health Check
        run: |
          tailscale ssh ${{ secrets.SSH_USER }}@${{ secrets.HOST_GREEN }} "cd ~/yquant && bash scripts/health-check.sh"
      
      - name: ðŸ“¢ Notify Success
        if: success()
        run: |
          echo "âœ… yQuant Deployment to GREEN successful!"
          echo "Ref: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: ðŸ“¢ Notify Failure
        if: failure()
        run: |
          echo "âŒ yQuant Deployment to GREEN failed!"
          echo "Check the logs above for details."
