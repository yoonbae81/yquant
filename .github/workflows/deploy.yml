name: Deploy yQuant Worker (Blue/Green)

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      target_worker:
        description: 'Target Worker to deploy (Blue or Green)'
        required: true
        default: 'GREEN'
        type: choice
        options:
          - BLUE
          - GREEN

jobs:
  deploy:
    name: Deploy All Services to ${{ github.event.inputs.target_worker || 'GREEN' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ”— Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          #oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          #oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          #tags: tag:ci
          #args: --accept-dns=false --accept-routes=false

      - name: ï¿½ Verify Tailscale Connection
        run: |
          echo "Checking Tailscale status..."
          tailscale status
          echo "---"
          echo "Tailscale IP:"
          tailscale ip -4

      - name: ðŸŽ¯ Set Target Worker
        id: set-host
        run: |
          if [ "${{ github.event.inputs.target_worker }}" == "GREEN" ] || [ -z "${{ github.event.inputs.target_worker }}" ]; then
            TARGET_HOST="${{ secrets.HOST_GREEN }}"
            TARGET_WORKER="GREEN"
          else
            TARGET_HOST="${{ secrets.HOST_BLUE }}"
            TARGET_WORKER="BLUE"
          fi
          echo "host=$TARGET_HOST" >> $GITHUB_OUTPUT
          echo "worker=$TARGET_WORKER" >> $GITHUB_OUTPUT
          echo "Target: $TARGET_WORKER ($TARGET_HOST)"

      - name: ðŸ”Ž Test Connection to Target
        run: |
          echo "Testing connection to ${{ steps.set-host.outputs.host }}..."
          tailscale ping -c 3 ${{ steps.set-host.outputs.host }} || echo "Ping failed, but will try SSH anyway"

      - name: ðŸš€ Deploy via Tailscale SSH
        run: |
          tailscale ssh ${{ secrets.SSH_USER }}@${{ steps.set-host.outputs.host }} << 'EOF'
            cd ~/yquant
            git fetch --all
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}
            bash scripts/deploy.sh
          EOF
      
      - name: ðŸ¥ Health Check
        run: |
          tailscale ssh ${{ secrets.SSH_USER }}@${{ steps.set-host.outputs.host }} "cd ~/yquant && bash scripts/health-check.sh"
      
      - name: ðŸ“¢ Notify Success
        if: success()
        run: |
          echo "âœ… yQuant Deployment to ${{ steps.set-host.outputs.worker }} successful!"
          echo "Ref: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: ðŸ“¢ Notify Failure
        if: failure()
        run: |
          echo "âŒ yQuant Deployment to ${{ steps.set-host.outputs.worker }} failed!"
          echo "Check the logs above for details."
