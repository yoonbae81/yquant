name: Deploy yQuant Worker

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy All Services to GREEN
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ”— Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          authkey: ${{ secrets.TS_AUTHKEY }}
          args: --accept-dns=false

      - name: âœ… Verify Tailscale Connection
        run: |
          echo "Checking Tailscale status..."
          tailscale status
          echo "---"
          echo "Tailscale IP:"
          tailscale ip -4

      - name: ğŸ” Resolve Target Host IP
        id: resolve-host
        run: |
          echo "Resolving Tailscale IP for ${{ secrets.HOST_GREEN }}..."
          # Extract IP from tailscale status (text parsing)
          TARGET_IP=$(tailscale status | grep -i "yq-green" | awk '{print $1}')
          
          if [ -z "$TARGET_IP" ]; then
            echo "âŒ Could not resolve target host IP"
            echo "Available hosts:"
            tailscale status
            exit 1
          fi
          
          echo "âœ… Resolved IP: $TARGET_IP"
          echo "ip=$TARGET_IP" >> $GITHUB_OUTPUT

      - name: ğŸ” Test Connection to Target
        run: |
          echo "Testing connection to ${{ steps.resolve-host.outputs.ip }}..."
          for i in {1..3}; do
            if tailscale ping -c 1 ${{ steps.resolve-host.outputs.ip }}; then
              echo "âœ… Connection successful!"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 3
          done
          echo "âš ï¸ Ping failed after 3 attempts, but will try SSH anyway"

      - name: ğŸš€ Deploy via Tailscale SSH
        run: |
          tailscale ssh ${{ secrets.SSH_USER }}@${{ steps.resolve-host.outputs.ip }} << 'EOF'
            cd ~/yquant
            git fetch --all
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}
            bash scripts/deploy.sh
          EOF
      
      - name: ğŸ¥ Health Check
        run: |
          tailscale ssh ${{ secrets.SSH_USER }}@${{ steps.resolve-host.outputs.ip }} "cd ~/yquant && bash scripts/health-check.sh"
      
      - name: ğŸ“¢ Notify Success
        if: success()
        run: |
          echo "âœ… yQuant Deployment to GREEN successful!"
          echo "Ref: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: ğŸ“¢ Notify Failure
        if: failure()
        run: |
          echo "âŒ yQuant Deployment to GREEN failed!"
          echo "Check the logs above for details."
